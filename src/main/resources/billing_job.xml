<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:batch="http://www.springframework.org/schema/batch"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/batch http://www.springframework.org/schema/batch/spring-batch.xsd">

    <batch:job id="billingJob" restartable="true" job-repository="batchJobRepository">
        <batch:step id="accountingStep" next="paymentStep">
            <batch:tasklet>
                <batch:chunk reader="accountingReader" processor="accountProcessor" writer="accountingWriter"
                             commit-interval="3" chunk-completion-policy="">
                </batch:chunk>
            </batch:tasklet>
        </batch:step>
        <batch:step id="paymentStep" next="messageStep">
            <batch:tasklet>
                <batch:chunk reader="billingReader" processor="paymentProcessor" writer="paymentWriter"
                             commit-interval="3" chunk-completion-policy="" skip-limit="100">
                    <batch:skippable-exception-classes>
                        <batch:include class="troywang.gringotts.base.exception.MoneyNotEnoughException"/>
                    </batch:skippable-exception-classes>
                </batch:chunk>
            </batch:tasklet>
        </batch:step>
        <batch:step id="messageStep">
            <batch:tasklet>
                <batch:chunk reader="messageReader" processor="messageProcessor" writer="messageDbWriter"
                             commit-interval="3" chunk-completion-policy="">
                </batch:chunk>
            </batch:tasklet>
        </batch:step>
    </batch:job>

    <!--JobRepo-->
    <bean id="batchJobRepository"
          class="org.springframework.batch.core.repository.support.JobRepositoryFactoryBean">
        <property name="dataSource" ref="batchDataSource"/>
        <property name="transactionManager" ref="transactionManager"/>
    </bean>

    <!--Readers-->
    <bean id="accountingReader" class="org.springframework.batch.item.database.JdbcPagingItemReader">
        <property name="dataSource" ref="billingDataSource"/>
        <property name="rowMapper" ref="accountReaderMapper"/>
        <property name="queryProvider" ref="accountQueryProvider"/>
    </bean>
    <bean id="accountReaderMapper" class="troywang.gringotts.dal.mapper.UserMapper"/>
    <bean id="accountQueryProvider"
          class="org.springframework.batch.item.database.support.MySqlPagingQueryProvider">
        <property name="selectClause" value="u.id,u.name,u.age,u.balance"/>
        <property name="fromClause" value="users u"/>
        <property name="sortKeys">
            <map>
                <entry key="u.id" value="ASCENDING"/>
            </map>
        </property>
    </bean>

    <bean id="billingReader" class="org.springframework.batch.item.database.JdbcPagingItemReader">
        <property name="dataSource" ref="billingDataSource"/>
        <property name="rowMapper" ref="billReaderMapper"/>
        <property name="queryProvider" ref="billQueryProvider"/>
    </bean>
    <bean id="billReaderMapper" class="troywang.gringotts.dal.mapper.BillReaderMapper"/>
    <bean id="billQueryProvider"
          class="org.springframework.batch.item.database.support.MySqlPagingQueryProvider">
        <property name="selectClause"
                  value="b.id,b.user_id,b.fees,b.paid_fees,b.unpaid_fees,b.pay_status,u.name,u.age,u.balance"/>
        <property name="fromClause" value="users u,bills b"/>
        <property name="whereClause" value="b.user_id=u.id"/>
        <property name="sortKeys">
            <map>
                <entry key="b.id" value="ASCENDING"/>
            </map>
        </property>
    </bean>

    <bean id="messageReader" class="org.springframework.batch.item.database.JdbcPagingItemReader">
        <property name="dataSource" ref="billingDataSource"/>
        <property name="rowMapper" ref="messageReaderMapper"/>
        <property name="queryProvider" ref="messageQueryProvider"/>
    </bean>
    <bean id="messageReaderMapper" class="troywang.gringotts.dal.mapper.MessageReaderMapper"/>
    <bean id="messageQueryProvider"
          class="org.springframework.batch.item.database.support.MySqlPagingQueryProvider">
        <property name="selectClause"
                  value="b.id,b.user_id,b.fees,b.paid_fees,b.unpaid_fees,b.pay_status,u.name,u.age,u.balance"/>
        <property name="fromClause" value="users u,bills b"/>
        <property name="whereClause"
                  value="b.user_id=u.id and b.pay_status=0"/>
        <property name="sortKeys">
            <map>
                <entry key="b.id" value="ASCENDING"/>
            </map>
        </property>
    </bean>

    <!--Processors-->
    <bean id="accountProcessor" class="troywang.gringotts.biz.processor.AccountingProcessor"/>
    <bean id="paymentProcessor" class="troywang.gringotts.biz.processor.PaymentProcessor"/>
    <bean id="messageProcessor" class="troywang.gringotts.biz.processor.MessagingProcessor"/>

    <!--Writers-->
    <bean id="accountingWriter" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
        <property name="dataSource" ref="billingDataSource"/>
        <property name="sql"
                  value="insert into bills(id,user_id,fees,paid_fees,unpaid_fees,pay_status) values(:id,:user.userId,:fees,:paidFees,:unpaidFees,:payStatus)"/>
        <property name="itemSqlParameterSourceProvider" ref="itemSqlParameterSourceProvider"/>
    </bean>

    <bean id="paymentWriter" class="org.springframework.batch.item.support.CompositeItemWriter">
        <property name="delegates">
            <list>
                <ref bean="payRecordDbWriter"/>
                <ref bean="payBillsDbUpdateWriter"/>
                <ref bean="payUsersDbUpdateWriter"/>
            </list>
        </property>
    </bean>
    <bean id="payRecordDbWriter" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
        <property name="dataSource" ref="billingDataSource"/>
        <property name="sql" value="insert into payrecords(id,bill_id,paid_fees) values(:id,:bill.id,:paidFees)"/>
        <property name="itemSqlParameterSourceProvider" ref="itemSqlParameterSourceProvider"/>
    </bean>
    <bean id="payBillsDbUpdateWriter" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
        <property name="dataSource" ref="billingDataSource"/>
        <property name="sql"
                  value="update bills b set b.paid_fees=:bill.paidFees,b.unpaid_fees=:bill.unpaidFees,b.pay_status=:bill.payStatus where b.id=:bill.id"/>
        <property name="itemSqlParameterSourceProvider" ref="itemSqlParameterSourceProvider"/>
    </bean>
    <bean id="payUsersDbUpdateWriter" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
        <property name="dataSource" ref="billingDataSource"/>
        <property name="sql" value="update users u set u.balance=:bill.user.balance where u.id=:bill.user.userId"/>
        <property name="itemSqlParameterSourceProvider" ref="itemSqlParameterSourceProvider"/>
    </bean>

    <bean id="messageDbWriter" class="org.springframework.batch.item.database.JdbcBatchItemWriter">
        <property name="dataSource" ref="billingDataSource"/>
        <property name="sql" value="insert into messages(id,user_id,content) values(:id,:user.userId,:content)"/>
        <property name="itemSqlParameterSourceProvider" ref="itemSqlParameterSourceProvider"/>
    </bean>

    <bean id="itemSqlParameterSourceProvider"
          class="org.springframework.batch.item.database.BeanPropertyItemSqlParameterSourceProvider"/>

    <!--DataSources-->
    <bean id="batchDataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
        <property name="url" value="jdbc:mysql://localhost:3306/batch_in_action"/>
        <property name="username" value="spring"/>
        <property name="password" value="Troywang2"/>
    </bean>

    <bean id="billingDataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
        <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
        <property name="url" value="jdbc:mysql://localhost:3306/batch_in_action"/>
        <property name="username" value="spring"/>
        <property name="password" value="Troywang2"/>
    </bean>

    <!--TransactionManager-->
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="batchDataSource"/>
    </bean>

</beans>